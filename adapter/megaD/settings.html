<table style="font-size: 12px">
    <tr>
        <td class="translate">Enabled:</td>
        <td>
            <select id="megaD_enabled">
                <option value="false" class="translate">false</option>
                <option value="true" class="translate">true</option>
            </select>
        </td>
    </tr>
    <tr>
        <td class="translate">CCU.IO Listen port:</td>
        <td><input id="megaD_settings_listen_port" size=5 maxsize=5 type="text"/></td>
    </tr>
</table>
<table id="megaList">
</table>
<input type="button" id="add_device" class="translateV" value="add_device"/><br><br>
<style>
.ports_table table, .ports_table th, .ports_table td, .ports_table tr
{
    border-spacing: 0px;
    border-collapse: collapse;
    margin: 0px;
    padding: 1px;
    border:1px solid black;
    text-align: center;
}
.ports_header {
    color: white;
    background: grey;
}
</style>
    <!--tr>
        <td class="translate">MegaD IP or name:</td>
        <td><input id="megaD_settings_ip" type="text"/></td>
    </tr>
    <tr>
        <td class="translate">MegaD ports count:</td>
        <td><input id="megaD_settings_ports_count" maxsize=2 size=2 type="text"/></td>
    </tr>
    <tr>
        <td class="translate">MegaD password:</td>
        <td><input id="megaD_settings_password" maxsize=3 size=3 type="text"/></td>
    </tr>
    <tr>
        <td class="translate">Poll interval (sec):</td>
        <td><input id="megaD_settings_poll" type="text"/></td>
    </tr-->
<h2 class="translate">Description:</h2>
<p class="translate">description</p>
<script type="text/javascript">
    var adapterWords = {
        "false":              {"en": "false",                "de": "nein",                 "ru": "нет"},
        "true":               {"en": "true",                 "de": "ja",                   "ru": "да"},
        "auto":               {"en": "auto",                 "de": "auto",                 "ru": "авто"},
        "Enabled:":           {"en": "Enabled:",             "de": "Aktiviert:",           "ru": "Активно:"},
        "Description:":       {"en": "Description:",         "de": "Beschreibung:",        "ru": "Описание:"},
        "add_device":         {"en": "Add new device",       "de": "Gerät hinzufügen",     "ru": "Добавить новый прибор"},
        "IP:":                {"en": "IP:",                  "de": "IP:",                  "ru": "IP:"},
        "Name:":              {"en": "Name:",                "de": "Name:",                "ru": "Имя прибора:"},
        "Password:":          {"en": "Password:",            "de": "Kennwort:",            "ru": "Пароль:"},
        "Poll interval(sec):":{"en": "Poll interval(sec):",  "de": "Pollinterval(sek):",   "ru": "Интервал опроса(сек)"},
        "Ports number:":      {"en": "Ports number:",        "de": "Portanzahl:",          "ru": "Кол-во портов:"},
        "Ports:":             {"en": "Ports:",               "de": "Ports:",               "ru": "Порты:"},
        "Num":                {"en": "Num",                  "de": "Num",                  "ru": "Номер"},
        "Name":               {"en": "Name",                 "de": "Name",                 "ru": "Имя"},
        "Is input":           {"en": "Is input",             "de": "Eingang",              "ru": "Вход"},
        "Is digital":         {"en": "Is digital",           "de": "Digital",              "ru": "Цифровой"},
        "Is switch":          {"en": "Is switch",            "de": "Schalter",             "ru": "Переключатель"},
        "Factor":             {"en": "Factor",               "de": "Faktor",               "ru": "Множитель"},
        "Offset":             {"en": "Offset",               "de": "Offset",               "ru": "Сдвиг"},
        "Room":               {"en": "Room",                 "de": "Zimmer",               "ru": "Комната"},
        "Role":               {"en": "Role",                 "de": "Rolle",                "ru": "Роль"},
        "del_device":         {"en": "Delete this device",   "de": "Diese Gerät entfernen","ru": "Удалить этот прибор"},
        "CCU.IO Listen port:": {"en": "CCU.IO Listen port:", "de": "CCU.IO Listen port:",  "ru": "Порт для веб сервера:"},
        "description":        {
            "en":  'This adapter is able to control the <a href="http://www.ab-log.ru/smart-house/ethernet/megad-328" target="_blank">MegaD</a> devices.' +
                   'The digital ports can be controlled with true or false <br>' +
                   'and the analog ports with float value from 0 to 1.<br>' +
                   'Analog value is automatically translated to 0-255 value.<br>',
            "de":  'This adapter is able to control the <a href="http://www.ab-log.ru/smart-house/ethernet/megad-328" target="_blank">MegaD</a> devices.' +
                   'The digital ports can be controlled with true or false <br>' +
                   'and the analog ports with float value from 0 to 1.<br>' +
                    'Analog value is automatically translated to 0-255 value.<br>',
            "ru":  'С помощью этого драйвера можно управлять и получать данные с <a href="http://www.ab-log.ru/smart-house/ethernet/megad-328" target="_blank">МегаДевайса</a>.<br>' +
                   'В цифровые порты можно записать значения true или false,<br>' +
                   'а в аналоговые значения от 0 до 1, например 0.5<br>' +
                   'Все аналоговые значения будут переконвертированы в значения 0-255<br>'+
                   'Свойство "Переключатель" используется только для цифровых входов и говорит о том: подключена кнопка или переключатель к этому входу.'
        },
        "helper": {
            "en":  'To enable reporting of the states from MegaD use following link<br>'+
                   '(Please replace <i>ccu_io_ip</i> with the ip address of the ccu.io):',
            "de":  'To enable reporting of the states from MegaD use following link<br>'+
                   '(Please replace <i>ccu_io_ip</i> with the ip address of the ccu.io):',
            "ru":  'Для настройки МегаДевайса, что бы прибор сам присылал значения при изменении портов, необходимо использовать в NetAction следующее<br>' +
                   '(Нужно только заменить <i>ccu_io_ip</i> настоящим ip адресом CCU.IO):'
        }
    };

    if (currentAdapterSettings.enabled) {
        $("#megaD_enabled option[value='false']").removeAttr("selected");
        $("#megaD_enabled option[value='true']").attr("selected", true);
    } else {
        $("#megaD_enabled option[value='true']").removeAttr("selected");
        $("#megaD_enabled option[value='false']").attr("selected", true);
    }

    $("#megaD_enabled").change(function () {
        currentAdapterSettings.enabled = ($("#megaD_enabled option:selected").val() == "false" ? false : true);
        updateAdapterSettings();
    });

    $("#megaPort").html(currentAdapterSettings.settings.ioListenPort);
    $("#megaD_settings_listen_port").val(currentAdapterSettings.settings.ioListenPort);

    $("#megaD_settings_listen_port").change(function () {
        currentAdapterSettings.settings.ioListenPort = $("#megaD_settings_listen_port").val();
        $(".megaPort").html(currentAdapterSettings.settings.ioListenPort);
        updateAdapterSettings();
    }).keyup(function() {$(this).trigger("change");});

    function showPort(dev, port) {
        var portSettings = currentAdapterSettings.settings.devices[dev].ports[port];
        var text = '<tr>';
        text += '<td>' + port + '</td>';
        text += '<td><input type="text"  id="port_name_'+dev+'_' + port + '" value="' + portSettings.name + '"></td>';
        text += '<td><input type="checkbox" id="port_input_' + dev + '_' + port + '" '+ (portSettings.input ? 'checked' : '')+ '></td>';
        text += '<td><input style="display: ' + (portSettings.input ? 'none': '') + '" type="checkbox" id="port_digital_'+dev+'_' + port + '" '+ (portSettings.digital ? 'checked' : '')+ '><span style="display: '+(!portSettings.input ? 'none': '')+'" id="port_digital_'+dev+'_' + port + '_auto">'+ translate('auto') + '</span></td>';
        text += '<td><input style="display: ' + (!portSettings.input ? 'none': '') + '" type="checkbox" id="port_switch_'+dev+'_' + port + '" '+ (portSettings.switch ? 'checked' : '')+ '></td>';
        text += '<td><input style="display: ' + ((!portSettings.input && portSettings.digital) ? 'none': '') + '" type="text" id="port_factor_'+dev+'_' + port + '"  size="4" value="'+ (portSettings.factor === undefined ? 1 : portSettings.factor)+ '"></td>';
        text += '<td><input style="display: ' + ((!portSettings.input && portSettings.digital) ? 'none': '') + '" type="text" id="port_offset_'+dev+'_' + port + '"  size="4" value="'+ (portSettings.offset === undefined ? 0 : portSettings.offset)+ '"></td>';
        text += '<td><input type="text" id="port_room_'+dev+'_' + port + '" value="'+ (portSettings.room === undefined ? '' : portSettings.room)+ '"></td>';
        text += '<td><input type="text" id="port_role_'+dev+'_' + port + '" value="'+ (portSettings.role === undefined ? '' : portSettings.role)+ '"></td>';

        text += '</tr>';
        return text;
    }

    function showPorts(dev) {
        var devSettings = currentAdapterSettings.settings.devices[dev];
        var text = '<table class="ports_table"><tr class="ports_header"><td>'+ translate('Num') +
                '</td><td>'+ translate('Name') +
                '</td><td>'+ translate('Is input') +
                '</td><td>'+ translate('Is digital') +
                '</td><td>'+ translate('Is switch') +
                '</td><td>'+ translate('Factor') +
                '</td><td>'+ translate('Offset') +
                '</td><td>'+ translate('Room') +
                '</td><td>'+ translate('Role') +
                '</td></tr>';
        for (var i = 0; i < devSettings.portsCount; i++) {
            text += showPort(dev, i);
        }
        text += '</table>';

        return text;
    }
    function translate(word) {
        return translateWord(word, '', adapterWords);
    }
    function showDevice(dev) {
        var devSettings = currentAdapterSettings.settings.devices[dev];
        var text = '<tr><td><table style="border: 1px solid black">';
        text += '<tr><td>'+ translate('IP:') + '</td><td><input type="text" id="dev_ip_' + dev + '" value="' + devSettings.ip + '"></td></tr>';
        text += '<tr><td>'+ translate('Name:') + '</td><td><input type="text" id="dev_name_' + dev + '" value="' + devSettings.name + '"></td></tr>';
        text += '<tr><td>'+ translate('Password:') + '</td><td><input type="text" id="dev_password_' + dev + '" value="' + devSettings.password + '"></td></tr>';
        text += '<tr><td>'+ translate('Poll interval(sec):') + '</td><td><input type="text" id="dev_poll_' + dev + '" value="' + devSettings.pollIntervalSec + '"></td></tr>';
        text += '<tr><td>'+ translate('Ports number:') + '</td><td><select id="dev_count_' + dev + '" value="' + devSettings.portsCount + '">'+
                '<option value="1">1</option>' +
                '<option value="2">2</option>' +
                '<option value="3">3</option>' +
                '<option value="4">4</option>' +
                '<option value="5">5</option>' +
                '<option value="6">6</option>' +
                '<option value="7">7</option>' +
                '<option value="8">8</option>' +
                '<option value="9">9</option>' +
                '<option value="10">10</option>' +
                '<option value="11">11</option>' +
                '<option value="12">12</option>' +
                '<option value="13">13</option>' +
                '<option value="14">14</option>' +
                '</select></td></tr>';

        text += '<tr><td style="vertical-align: top">'+ translate('Ports:') + '</td><td id="dev_ports_' + dev + '">';
        text += showPorts(dev);

        text += '</td></tr>'
        text += '<tr><td></td><td><input type="button" value="'+ translate('del_device') + '" id="del_device_' + dev + '"></td></tr>';
        text += '<tr><td></td><td>' + translate('helper') + ' "http://ccu_io_ip<span class="megaPort">' + (currentAdapterSettings.settings.ioListenPort != 80 ? (':' + currentAdapterSettings.settings.ioListenPort) : '') + '</span>/<span id="megaName_' + dev + '">' + devSettings.name + '</span>/"</td></tr>';
        text += '</table></td></tr>';
        return text;
    }

    function setPortsHandlers (dev) {
        var devSettings = currentAdapterSettings.settings.devices[dev];
        for (var i = 0; i < devSettings.portsCount; i++) {
            $('#port_name_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_name_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].name = $(this).val();
                updateAdapterSettings();
            });
            $('#port_input_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_input_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].input = $(this).prop("checked");
                if (currentAdapterSettings.settings.devices[id].ports[port].input) {
                    $('#port_digital_' + id + '_' + port).prop("checked", true);
                    $('#port_digital_' + id + '_' + port).hide();
                    $('#port_digital_' + id + '_' + port + '_auto').show();
                    $('#port_switch_' + id + '_' + port).show();
                } else {
                    $('#port_digital_' + id + '_' + port).show();
                    $('#port_digital_' + id + '_' + port + '_auto').hide();
                    $('#port_switch_' + id + '_' + port).hide();
                }
                updateAdapterSettings();
            });
            $('#port_digital_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_digital_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].digital = $(this).prop("checked");
                updateAdapterSettings();
            });
            $('#port_switch_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_switch_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].switch = $(this).val();
                updateAdapterSettings();
            });
            $('#port_factor_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_factor_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].factor = $(this).val();
                updateAdapterSettings();
            });
            $('#port_room_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_room_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].room = $(this).val();
                updateAdapterSettings();
            });
            $('#port_role_' + dev + '_' + i).change(function () {
                var id = $(this).attr('id').substring("port_role_".length);
                var pos = id.lastIndexOf('_');
                var port = id.substring(pos + 1);
                id = id.substring(0, pos);
                currentAdapterSettings.settings.devices[id].ports[port].role = $(this).val();
                updateAdapterSettings();
            });
        }
    }

    function showDevices () {
        console.log("A");
        var text = "";
        for (var dev in currentAdapterSettings.settings.devices) {
            text += showDevice(dev);
        }
        $('#megaList').html(text);

        //Install handlers
        for (var dev in currentAdapterSettings.settings.devices) {
            $('#dev_ip_' + dev).change(function () {
                var id = $(this).attr('id').substring("dev_ip_".length);
                currentAdapterSettings.settings.devices[id].ip = $(this).val();
                updateAdapterSettings();
            });

            $('#dev_name_' + dev).change(function () {
                var id = $(this).attr('id').substring("dev_name_".length);
                currentAdapterSettings.settings.devices[id].name = $(this).val();
                $('#megaName_' + id).html($(this).val());
                updateAdapterSettings();
            }).keyup(function() {$(this).trigger("change");});

            $('#dev_password_' + dev).change(function () {
                var id = $(this).attr('id').substring("dev_password_".length);
                currentAdapterSettings.settings.devices[id].password = $(this).val();
                updateAdapterSettings();
            });

            $('#dev_poll_' + dev).change(function () {
                var id = $(this).attr('id').substring("dev_poll_".length);
                currentAdapterSettings.settings.devices[id].pollIntervalSec = $(this).val();
                updateAdapterSettings();
            });

            $('#dev_count_' + dev + ' option[value="' + currentAdapterSettings.settings.devices[dev].portsCount + '"]').attr("selected", true);

            $('#dev_count_' + dev).change(function () {
                var id = $(this).attr('id').substring("dev_count_".length);
                var val = parseInt($(this).val());
                if (val > 14) {
                    val = 14;
                    $(this).val(val);
                }

                if (currentAdapterSettings.settings.devices[id].portsCount != val) {
                    if (val < currentAdapterSettings.settings.devices[id].portsCount) {
                        currentAdapterSettings.settings.devices[id].ports =
                                currentAdapterSettings.settings.devices[id].ports.slice(0, val - 0);
                    } else {
                        for (var t = currentAdapterSettings.settings.devices[id].portsCount; t < val; t++) {
                            currentAdapterSettings.settings.devices[id].ports.push({
                                "name":   "port" + t,
                                "input":  (t < 7) ? true : false,
                                "digital": true,
                                "switch":  true,
                                "offset":  0,
                                "factor":  1
                            });
                        }
                    }
                    currentAdapterSettings.settings.devices[id].portsCount = val;
                    $('#dev_ports_' + dev).html(showPorts(id));
                    setPortsHandlers(dev);
                }
                updateAdapterSettings();
            });
            setPortsHandlers(dev);
            $('#del_device_' + dev).button().click(function () {
                var id = $(this).attr('id').substring("del_device_".length);
                delete currentAdapterSettings.settings.devices[id];
                showDevices();
                updateAdapterSettings();
            });
        }
    }

    /*
    $("#megaD_settings_ports_count").val(currentAdapterSettings.settings.portsCount);

    $("#megaD_settings_ports_count").change(function () {
        currentAdapterSettings.settings.portsCount = $("#megaD_settings_ports_count").val();
        updateAdapterSettings();
    });

    $("#megaD_settings_password").val(currentAdapterSettings.settings.password);

    $("#megaD_settings_password").change(function () {
        currentAdapterSettings.settings.password = $("#megaD_settings_password").val();
        updateAdapterSettings();
    });
  
    $("#megaD_settings_ip").val(currentAdapterSettings.settings.ip);

    $("#megaD_settings_ip").change(function () {
        currentAdapterSettings.settings.ip = $("#megaD_settings_ip").val();
        updateAdapterSettings();
    });

    $("#megaD_settings_poll").val(currentAdapterSettings.settings.pollIntervalSec);

    $("#megaD_settings_poll").change(function () {
        currentAdapterSettings.settings.pollIntervalSec = $("#megaD_settings_poll").val();
        updateAdapterSettings();
    });*/
    $('#add_device').button().click(function () {
        // Find free id
        var i = 1;
        while (currentAdapterSettings.settings.devices["_"+i]) i++;

        currentAdapterSettings.settings.devices["_" + i] = {
            "name":            "mega" + i,
            "ip":              "0.0.0.0",
            "pollIntervalSec": 30,
            "portsCount":      14,
            "password":        "sec",
            "ports": [
                {
                    "name": "port0",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port1",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port2",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port3",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port4",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port5",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port6",
                    "input": true,
                    "switch": true,
                    "offset": 0,
                    "factor": 1
                },
                {
                    "name": "port7",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port8",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port9",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port10",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port11",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port12",
                    "input": false,
                    "digital": true
                },
                {
                    "name": "port13",
                    "input": false,
                    "digital": true
                }
            ]
        };

        showDevices();
        updateAdapterSettings();
    });


    translateAll(ccuIoSettings.language, adapterWords);
    showDevices();
</script>
